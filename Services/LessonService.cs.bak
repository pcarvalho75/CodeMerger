using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.Json;
using CodeMerger.Models;

namespace CodeMerger.Services
{
    /// <summary>
    /// Handles storage and retrieval of self-improvement lessons.
    /// Lessons are observations Claude logs when it notices something could be improved.
    /// Limited to 100 lessons maximum.
    /// </summary>
    public class LessonService
    {
        private const int MaxLessons = 100;
        private const string LessonsFileName = "lessons.json";

        private static readonly string AppDataFolder = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "CodeMerger");

        private static readonly JsonSerializerOptions JsonOptions = new()
        {
            WriteIndented = true,
            PropertyNamingPolicy = JsonNamingPolicy.CamelCase
        };

        public LessonService()
        {
            if (!Directory.Exists(AppDataFolder))
            {
                Directory.CreateDirectory(AppDataFolder);
            }
        }

        private string GetLessonsFilePath()
        {
            return Path.Combine(AppDataFolder, LessonsFileName);
        }

        /// <summary>
        /// Gets all current lessons.
        /// </summary>
        public List<Lesson> GetLessons()
        {
            var filePath = GetLessonsFilePath();
            if (!File.Exists(filePath))
            {
                return new List<Lesson>();
            }

            try
            {
                var json = File.ReadAllText(filePath);
                return JsonSerializer.Deserialize<List<Lesson>>(json, JsonOptions) ?? new List<Lesson>();
            }
            catch
            {
                return new List<Lesson>();
            }
        }

        /// <summary>
        /// Logs a new lesson. Returns false if at capacity (100 lessons).
        /// </summary>
        public bool LogLesson(string type, string component, string observation, string proposal, string? suggestedCode = null)
        {
            var lessons = GetLessons();

            if (lessons.Count >= MaxLessons)
            {
                return false;
            }

            var nextNumber = lessons.Count > 0 ? lessons.Max(l => l.Number) + 1 : 1;

            var lesson = new Lesson
            {
                Number = nextNumber,
                Timestamp = DateTime.Now,
                Type = type,
                Component = component,
                Observation = observation,
                Proposal = proposal,
                SuggestedCode = suggestedCode
            };

            lessons.Add(lesson);
            SaveLessons(lessons);
            return true;
        }

        /// <summary>
        /// Deletes a specific lesson by number.
        /// </summary>
        public bool DeleteLesson(int number)
        {
            var lessons = GetLessons();
            var lesson = lessons.FirstOrDefault(l => l.Number == number);

            if (lesson == null)
            {
                return false;
            }

            lessons.Remove(lesson);
            
            // Renumber remaining lessons
            for (int i = 0; i < lessons.Count; i++)
            {
                lessons[i].Number = i + 1;
            }

            SaveLessons(lessons);
            return true;
        }

        /// <summary>
        /// Deletes all lessons.
        /// </summary>
        public void ClearAllLessons()
        {
            SaveLessons(new List<Lesson>());
        }

        /// <summary>
        /// Gets the current count of lessons.
        /// </summary>
        public int GetLessonCount()
        {
            return GetLessons().Count;
        }

        /// <summary>
        /// Checks if more lessons can be logged.
        /// </summary>
        public bool CanLogMore()
        {
            return GetLessonCount() < MaxLessons;
        }

        private void SaveLessons(List<Lesson> lessons)
        {
            var filePath = GetLessonsFilePath();
            var json = JsonSerializer.Serialize(lessons, JsonOptions);
            File.WriteAllText(filePath, json);
        }
    }
}
